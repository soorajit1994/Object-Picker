var xpath_dataRec=[];
var xpath_dataRec_api=[];
var APIS=[];
var flag_api=0;
var XPATHS=[];

var xpath_data=[];
function containsObject(obj, list) {
  var i;
  for (i = 0; i < list.length; i++) {
      if (JSON.stringify(list[i]) === JSON.stringify(obj)) {
          return true;
      }
  }

  return false;
}
function htmlEntities(str) {
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}
////$('#Paris').click()
$('#stop').hide();
var watch = (function(){
    var timer = document.getElementById("timer");
    var stop = document.getElementById("stop");
    var reset = document.getElementById("reset");
    var time = "00:00"
    var seconds = 0;
    var minutes = 0;
    var t;
  
    timer.textContent = time;
  
    function buildTimer () {
      seconds++;
          if (seconds >= 60) {
              seconds = 0;
              minutes++;
              if (minutes >= 60) {
                  minutes = 0;
                  seconds = 0;
              }
          }
      timer.textContent = (minutes < 10 ? "0" + minutes.toString(): minutes) + ":" + (seconds < 10 ? "0" + seconds.toString(): seconds);
        


         try{
           
          $.getJSON('/QRec', {
				  
            track:"Hello",
         }, function(data) {
          if(data.status==="FAIL"){
            
            $.notify("Error: Driver is not initialized","error");
      
            clearTimeout(t);
        timer.textContent = time;
        seconds = 0; minutes = 0;
        $('#stop').hide();
        $('#start').show();
      

          
          }
          else{
       var listss=''
       if(data.data!==null&&data.data.length!==0){
        if(containsObject(JSON.parse(data.data),xpath_data)){
         //pass
         console.log("Already Present")
        }
        else{
          ///console.log(data.result[d],xpath_data);
          xpath_data.push(JSON.parse(data.data));
        }
    
        var TAB=`<div id="tabhead" class="tab">
        <button class="tablinks" ><b>Objects</b></button> </div>`;
       $( "#tabhead" ).replaceWith( TAB);
       listss+=`<div style='margin:5px;'><label >About `+String(xpath_data.length)+` results</label><input style="margin:5px" placeholder="Search for objects.." type="text" id="myInput" onkeyup="searchFunction()" /></div>`;
       listss+=`<ul id="mylist">`
       for(var k=0;k<xpath_data.length;k++){
         var TXT=''
         xpath_data[k]['TEXT'].trim()===""?TXT=xpath_data[k]['OBJ']:TXT=xpath_data[k]['TEXT'];
         if(TXT.length>70){
           TXT=TXT.substring(0,70)+"..."
         }
         listss+=`<li><div class='sectionContent `+xpath_data[k]['TAG']+`'><input id="CHECK_ELE" type="checkbox" name="Ele_value" value="`+xpath_data[k]['XPATH']+`" rel2="`+xpath_data[k]['TAG']+`" rel3="`+xpath_data[k]['TEXT']+`" rel="`+xpath_data[k]['OBJ']+`" ><button type='button' onclick="showDetails(`+k+`);" class='collapsible2'><strong>`+htmlEntities(TXT)+`<i style="float:right" class="fa fa-angle-right"></i></strong></button></div></li>`;
 
         
 
 
       
      
     }
     listss+="</ul>"
    
     document.getElementById("mainContainer2").innerHTML=listss
     sections = $('.sectionContent');
     updateContentVisibility();
    
     $('#proceed').prop('disabled', false);
     //// showDetails(xpath_data.length-1);
      }
            
     
        
    }
        });


     }
     catch(err){
      $.notify("Object Picker says:"+err, "error");
      console.log(err);
      $("#stop").trigger("click");
      
      $.getJSON('/QRec_Stop', {
				  
        track:"Hello",
     }, function(data) {


     });

     }
    }
    function stopTimer () {
      stop.addEventListener("click", function(){
        clearTimeout(t);
        timer.textContent = time;
        seconds = 0; minutes = 0;
        $('#stop').hide();
        $('#start').show();
        
        $.getJSON('/QRec_Stop', {
				  
          track:"Hello",
       }, function(data) {
         ///
  
  
       });
        
      })
     
    }
    function startTimer () {
      start.addEventListener("click", function(){
        clearTimeout(t);
        t = setInterval(buildTimer,1000);
        $('#start').hide();
        $('#stop').show();
      });
      
    }
    
    return {
      start: startTimer(),
      stop: stopTimer()
      
    };
  })()
  window.onscroll = function() {myFunction()};

var navbar = document.getElementById("navbar");
var sticky = navbar.offsetTop;

function myFunction() {
  if (window.pageYOffset >= sticky) {
    navbar.classList.add("sticky")
  } else {
    navbar.classList.remove("sticky");
  }
}

window.addEventListener("beforeunload", function (e) {
    $("#stop").click()
  });


  function convertArrayOfObjectsToCSVRec(args) {
    var result, ctr, keys, columnDelimiter, lineDelimiter, data;

    data = args.data || null;
    if (data == null || !data.length) {
        return null;
    }

    columnDelimiter = args.columnDelimiter || ',';
    lineDelimiter = args.lineDelimiter || '\n';

    keys = Object.keys(data[0]);

    result = '';
    result += keys.join(columnDelimiter);
    result += lineDelimiter;

    data.forEach(function(item) {
        ctr = 0;
        keys.forEach(function(key) {
            if (ctr > 0) result += columnDelimiter;

            result += item[key];
            ctr++;
        });
        result += lineDelimiter;
    });

    return result;
}
function convertArrayOfObjectsToCSVRec_api(args) {
  var result, ctr, keys, columnDelimiter, lineDelimiter, data;

  data = args.data || null;
  if (data == null || !data.length) {
      return null;
  }

  columnDelimiter = args.columnDelimiter || ',';
  lineDelimiter = args.lineDelimiter || '\n';

  keys = Object.keys(data[0]);

  result = '';
  result += keys.join(columnDelimiter);
  result += lineDelimiter;

  data.forEach(function(item) {
      ctr = 0;
      keys.forEach(function(key) {
          if (ctr > 0) result += columnDelimiter;

          result += item[key];
          ctr++;
      });
      result += lineDelimiter;
  });

  return result;
}
function downloadCSVRec(args) {
  if(xpath_dataRec.length===0){

    $.notify("Empty Recordings", "warn");
  }
    var data, filename, link;

    var csv = convertArrayOfObjectsToCSVRec({
        data: xpath_dataRec
    });
    if (csv == null) return;

    filename = args.filename || 'export.csv';

    if (!csv.match(/^data:text\/csv/i)) {
        csv = 'data:text/csv;charset=utf-8,' + csv;
    }
    data = encodeURI(csv);

    link = document.createElement('a');
    link.setAttribute('href', data);
    link.setAttribute('download', filename);
    link.click();
}




// When the user clicks on the button, scroll to the top of the document
var btn = $('#button');

$(window).scroll(function() {
  if ($(window).scrollTop() > 300) {
    btn.addClass('show');
  } else {
    btn.removeClass('show');
  }
});

btn.on('click', function(e) {
  e.preventDefault();
  $('html, body').animate({scrollTop:0}, '300');
});



$('input[type="radio"]').on('change', function(){
var choice= $(this).val();
if(choice==="api"){
  $('#myTable').hide();


  flag_api=1;
 



}
else{

 

  flag_api=0;

}
});


function EraseRec(){
document.getElementById("mylist").innerHTML=`    <li><div class='sectionContent'><button type='button' class='collapsible'> <i class="fa fa-rocket"></i> <strong> Launch the browser and Go to URL.</strong></button></div></li>
<li><div class='sectionContent'><button type='button' class='collapsible'> <i class="fa fa-list"></i><strong> Once Launched pick objects.</strong> </button></div></li>
<li><div class='sectionContent'><button type='button' class='collapsible'> <i class="fa fa-file-excel-o"></i><strong> Save all objects as Excel. </strong> </button></div></li>
<li><div class='sectionContent'><button type='button' class='collapsible'> <i class="fa fa-eraser"></i> <strong>Click on  Eraser to clear. </strong></button></div></li>
`;
  xpath_data=[];
  document.getElementById("OPP").innerHTML='';
  document.getElementById("CSS").innerHTML='';
  document.getElementById("PROP").innerHTML='';
  document.getElementById("Tokyo").innerHTML='';
  $("#card-footer").fadeOut();
   
 

}

function openCity(evt, cityName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
}

$(document).ready(function() {
document.getElementById("prop").click();
$("#loader").hide();

});
function isNumber(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}

function setFontSize(el) {
    var fontSize = el.val();
    
    if ( isNumber(fontSize) && fontSize >= 0.5 ) {
      $('body').css({ fontSize: fontSize + 'em' });
    } else if ( fontSize ) {
      el.val('1');
      $('body').css({ fontSize: '1em' });  
    }
}

$(function() {
  
  $('#fontSize')
    .bind('change', function(){ setFontSize($(this)); })
    .bind('keyup', function(e){
      if (e.keyCode == 27) {
        $(this).val('1');
        $('#Tokyo').css({ fontSize: '1em' });  
      } else {
        setFontSize($(this));
      }
    });
  
  $(window)
    .bind('keyup', function(e){
      if (e.keyCode == 27) {
        $('#fontSize').val('1');
        $('#Tokyo').css({ fontSize: '1em' });  
      }
    });
  
});

function Launch(){


  $.getJSON('/launch', {
				  
    url:$('input[name=url]').val(),
 }, function(data) {

console.log(data);
 });


}

function CopyToClipboard(containerid) {
  if (document.selection) { 
      var range = document.body.createTextRange();
      range.moveToElementText(document.getElementById(containerid));
      range.select().createTextRange();
      document.execCommand("copy"); 
  
  } else if (window.getSelection) {
      var range = document.createRange();
       range.selectNode(document.getElementById(containerid));
       window.getSelection().addRange(range);
       document.execCommand("copy");
    $.notify("Xpath Copied to Clipboard","success"); 
  }}


  function GetAll(){
    $("#loader").show();

    $.getJSON('/collect', {
				  
      track:"Hello",
   }, function(data) {

    if(data.status==="FAIL"){
      $.notify("Error: Driver is not initialized","error");
     $("#loader").hide();

    }



    else{
    for (d=0;d<data.data.length;d++){
      if(containsObject(data.data[d],xpath_data)){
       //pass
      }
      else{
        ///console.log(data.result[d],xpath_data);
        xpath_data.push(data.data[d]);
      }
    }
   
            var listss=''
   
    if(xpath_data!==null&&xpath_data.length!==0){
       var TAB=`<div id="tabhead" class="tab">
       <button class="tablinks" ><b>Objects</b></button> </div>`;
      $( "#tabhead" ).replaceWith( TAB);
      listss+=`<div style='margin:5px;'><label >About `+String(xpath_data.length)+` results</label><input style="margin:5px" placeholder="Search for objects.." type="text" id="myInput" onkeyup="searchFunction()" /></div>`;
      listss+=`<ul id="mylist">`
      for(var k=0;k<xpath_data.length;k++){
        var TXT=''
        xpath_data[k]['TEXT'].trim()===""?TXT=xpath_data[k]['OBJ']:TXT=xpath_data[k]['TEXT'];
        if(TXT.length>70){
          TXT=TXT.substring(0,70)+"..."
        }
        listss+=`<li><div class='sectionContent `+xpath_data[k]['TAG']+`'><input id="CHECK_ELE" type="checkbox" name="Ele_value" value="`+xpath_data[k]['XPATH']+`" rel2="`+xpath_data[k]['TAG']+`" rel3="`+xpath_data[k]['TEXT']+`" rel="`+xpath_data[k]['OBJ']+`" ><button type='button' onclick="showDetails(`+k+`);"  class='collapsible2'><strong>`+TXT+`<i style="float:right" class="fa fa-angle-right"></i></strong></button></div></li>`;

        


      
     
    }
    listss+="</ul>"
   
    document.getElementById("mainContainer2").innerHTML=listss
    sections = $('.sectionContent');
    updateContentVisibility();
    $("#loader").hide();
    $('#proceed').prop('disabled', false);
  ////  showDetails(xpath_data.length-1);
    }
  }
   });


  }

  function showDetails(x){
   
    $('#modal_click_property').modal('show'); 
   

var row_data=xpath_data[x];
var node_html=''
document.getElementById("pencil").setAttribute("onclick","editDetails("+x+")")

document.getElementById("object").innerHTML=`<b>`+row_data["OBJ"] +`</b>`;
for(var t=0;t<row_data["NODES"].length;t++){
  var table = document.getElementById('myTable').getElementsByTagName('tbody')[0];
  var row = table;
 
  
  node_html += '<tr><td class="text-left">'+row_data["NODES"][t]+'</td><td class="text-left">'+row_data["VALUES"][t].substring(0,50)+'</td></tr>';

 
  }
  row.innerHTML=node_html;
  var style_html='';
  for(var t=0;t<row_data["STYLE_NODES"].length;t++){
    var table2 = document.getElementById('myTable2').getElementsByTagName('tbody')[0];
    var row2 = table2;
   
    
    style_html+=  '<tr><td class="text-left">'+row_data["STYLE_NODES"][t]+'</td><td class="text-left">'+row_data["STYLE_VALUES"][t].substring(0,50)+'</td></tr>';

   
    }
    row2.innerHTML=style_html;
    var op_html=''
    for(var t=0;t<row_data["OPERATIONS"].length;t++){
      var table3 = document.getElementById('myTable3').getElementsByTagName('tbody')[0];
      var row3 = table3;
     
      
      op_html+= '<tr><td class="text-left">'+row_data["OPERATIONS"][t]+'</td><td class="text-left">'+row_data["OPERATIONS_VALUES"][t].substring(0,50)+'</td></tr>';

     
      }
      row3.innerHTML=op_html;
    document.getElementById("Tokyo").innerHTML=row_data["HIERARCHY"];
    document.getElementById("card-footer").innerHTML="<p >Relative Xpath: <span id='div1' >"+row_data["XPATH"]+"</span><a  id='locate' onclick='Locate();' title='Locate element on Page' href='#' style='margin:5px;font-size:20px;float:right;color:white;'>   <i  class='fa fa-eye' ></i></a><a style='margin:5px;font-size:20px;float:right;color:white;' id='copy' title='Copy Xpath to Clipboard' href='#'><i  class='fa fa-clipboard' ></i></a> </p>";
    $("#card-footer").fadeIn();
    var myEl = document.getElementById('copy');
    
    myEl.addEventListener('click', function() {
      CopyToClipboard('div1');
    }, false);

    }
    
  
  

  function searchFunction() {
    var input, filter, ul, li, a, i, txtValue;
    input = document.getElementById("myInput");
    filter = input.value.toUpperCase();
    ul = document.getElementById("mylist");
    li = ul.getElementsByTagName("li");
    for (i = 0; i < li.length; i++) {
        a = li[i].getElementsByTagName("button")[0];
        txtValue = a.textContent || a.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = "";
        } else {
            li[i].style.display = "none";
        }
    }
}

var toggler = document.getElementsByClassName("caret2");
var i;

for (i = 0; i < toggler.length; i++) {
  toggler[i].addEventListener("click", function() {
    this.parentElement.querySelector(".nested").classList.toggle("active");
    this.classList.toggle("caret2-down");
  });
}


function Locate(){
 
  var x=document.getElementById("div1").innerText;
  
console.log(x);
$.getJSON('/locate', {
  xpath:x,
  }, function(data) {

    if(data.status==="FAIL"){
      $.notify("Failed to locate the element", "warn");

    }


  });
 }


 function editDetails(x){
  
document.getElementById("object").setAttribute("contenteditable", "true");
document.getElementById("object").setAttribute("onblur", "blurfunc("+x+")");
 }
 function blurfunc(x){
  var X=xpath_data[x]["XPATH"]
  document.getElementById("object").setAttribute("contenteditable", "false");
  var T=document.getElementById("object").innerText;

  var eles = document.getElementsByName("Ele_value");
  for(var e=0;e<eles.length;e++){


    if(eles[e].value===X){
      eles[e].setAttribute("rel", document.getElementById("object").innerText.trim());
      eles[e].nextSibling.innerHTML=`<strong>`+document.getElementById("object").innerText.trim()+`<i style="float:right" class="fa fa-angle-right"></i></strong>`
      xpath_data[x]["OBJ"]=document.getElementById("object").innerText.trim();

        break;
    }
  }





 }
